---
title: Malaria immunisation across Africa
author: Estimating the costs of implementation
fig_height: 2.6
fig_width: 4
output:
  html_document:
    toc: true
    toc_float: true
    theme: yeti
---

Elisa Sicuri and Joe Brew

```{r, echo = FALSE, warning = FALSE, message = FALSE, comment = NA, error= FALSE, cache = FALSE}
# No scientific notation
options(scipen=999)

# Packages 
library(xtable)
library(knitr)
library(ggplot2) 
library(dplyr)
library(rgeos)
library(RColorBrewer)
library(Rmisc)
library(rgdal)
library(raster)
library(sp)
library(leaflet)
library(ggmap)
library(gsheet)
library(Hmisc)
library(maps)
library(rgdal)
library(readr)
library(Hmisc)
library(ggthemes)

# Basic knitr options
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, # Render report, even with errors
               cache = F)

```

```{r setup, include=FALSE, echo = FALSE}
library(knitr)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
```


```{r}
#### READ IN AND CLEAN UP DATA
# Get link of master spreadsheet of vaccination costs
if('already_read.RData' %in% dir()){
  load('already_read.RData')
} else {
  url_data <- 'https://docs.google.com/spreadsheets/d/1inbYJUdu5uMC0pJOJAA25QCUZ6xFyvWmldjChWlGZok/edit?usp=sharing'
  url_papers <- 'https://docs.google.com/spreadsheets/d/1If4C6jECPifBweOCsdlQm4E7pC3xTf_B_Blt2ufWYQo/edit?usp=sharing'
  
  # Read in as dataframe
  df <- gsheet2tbl(url_data)
  papers <- gsheet2tbl(url_papers)
  
  
  # CLEAN UP LIST OF PAPERS
  # Sort by malaria status
  papers$has_malaria <- 
    grepl('malaria', tolower(papers$abstract)) | grepl('malaria', tolower(papers$title))
  
  # Remove those that we're not including
  papers <-
    papers %>%
    filter(included_in_db %in% c('yes', 'Yes', 'Y', 'y'))
  
  # CLEAN UP DATASET
  df$disease <- toupper(df$disease)
  df$type <- Hmisc::capitalize(tolower(df$type))
  # Re-categorize for transportation
  df$type <-
    ifelse(df$type %in% c('Cold chain',
                          'Cold storage',
                          'Distribution',
                          'Storage and transportation',
                          'International handling'),
           'Transportation', 
           df$type)
  # Re-catgorize for administration
  df$type <- ifelse(df$type %in% c('Delivery',
                                   'Handling',
                                   'Logistic',
                                   'Introduction cost',
                                   'Monitoring',
                                   'Operational cost'),
                    'Administration',
                    df$type)
  # Re-categorize for human resources
  df$type <- ifelse(df$type %in% c('Coordination and supervision',
                                   'Management',
                                   'Prevention (including human ressources)',
                                   'Staff'),
                    'Human resources',
                    df$type)
  # Re-categorize for Equipment: Stationary
  df$type <- ifelse(df$type %in% c('Stationery'), 'Equipment', df$type)
  # Remove those which can't be categorized
  df <- df[!df$type %in% c('Everything except vaccine',
                                'Total',
                                'Vaccine'),]
  # Re-categorized for sensitisation
  df$type <- ifelse(df$type %in% c('Sensitation',
                                   'Social mobilization'),
                    'Sensitisation',
                    df$type)
  
  # Clean up country
  df$country <- Hmisc::capitalize(tolower(df$country))
  df$country <-
    ifelse(grepl('Multiple', df$country),
           'Multiple',
           df$country)
  
  # Remove those that aren't in Africa
  df <- df[df$country != 'Brazil',]
  
  # Get currency conversion for foreign currencies
  df$currency <- toupper(df$currency)
  currency <- read.csv('currency.csv', header = FALSE )
  currency <- currency[,c(4,5,6)]
  names(currency) <- c('currency', 'date', 'value')
  currency$date <- as.Date(substr(currency$date, 1, 10))
  currency <- currency %>%
    filter(currency %in% c('EUR', 'ZAR'))
  df$date <- as.Date(paste0(df$year, '-06-01'))
  df <- left_join(x = df,
                 y = currency,
                 by = c("currency", "date"))
  
  # Get currency conversion for USD (ie, for inflation)
  # Using http://data.bls.gov/cgi-bin/cpicalc.pl
  inflation <- read_csv('usd_inflation.csv')
  inflation$date <- as.Date(paste0(inflation$year, '-06-01'))
  inflation$year <- NULL
  
  # First convert from local to USD
  df$usd <- 
    ifelse(!df$currency %in% c('USD', 'PERCENTAGE'),
           df$cost / df$value,
           ifelse(df$currency == 'USD',
                  df$cost,
                  NA))
  
  # Now convert from USD to 2016 USD
  names(inflation) <- c('value_2016', 'date')
  df <- df %>% 
    left_join(inflation,
              by = 'date')
  df$usd_2016 <-
    ifelse(df$currency == 'PERCENTAGE',
           NA,
           df$usd * (df$value_2016/100))
  
  # Adjust for dose number
  df$usd_2016 <- df$usd_2016 / df$doses
  
    # Convert percentages to overall values
  x <- df %>%
    dplyr::filter(currency != 'PERCENTAGE') %>%
    dplyr::group_by(country, source) %>%
    dplyr::summarise(avg = mean(usd_2016),
                     items = length(type)) %>%
    ungroup %>%
    dplyr::summarise(avg_item_cost = mean(avg))
  average_overall_cost <- x$avg_item_cost * length(unique(df$type))
  
  df$estimated_from_percentage <-
    ifelse(is.na(df$usd_2016), TRUE, FALSE)
  
  df$usd_2016 <-
    ifelse(is.na(df$usd_2016),
           (df$cost/100) * average_overall_cost,
           df$usd_2016)
  
  # Clean up column names
  df <- 
    df %>%
    dplyr::select(disease,
                  doses,
                  type,
                  source,
                  source,
                  link,
                  year,
                  country,
                  usd_2016) %>%
    dplyr::rename(cost = usd_2016)
  
  # Remove the one very high HIV human resources study (> 3 sd)
  df <- df %>% 
    dplyr::filter(cost < 30)
  
  # Save an image
  save.image('already_read.RData')
}
```

```{r}
# Map of Africa
africa <- readOGR('africa_shp', 
                  'AfricanCountires',
                  verbose = FALSE)
cols <- colorRampPalette(brewer.pal(9, 'Reds')[3:9])(nrow(africa))
cols <- sample(cols)
plot(africa, col = cols, border = NA)
```

# Context

This document provides an overview of the GSK malaria immunisation costing estimation. This project is being carried out under the direction of Dr. Elisa Sicuri. Its purpose is to provide country-specific estimates for the non-vaccine costs of implementing large-scale malaria immunisation across sub-saharan Africa. It is considered a "work in progress" and is intended for further review and revisions prior to publication.

# Introduction  

Given that the a truly large-scale Malaria vaccination campaign has _never_ taken place, it is impossible to know Malaria immunisation unit costs through direct prior experience. However, it is possible to estimate these costs indirectly by gathering data on the costs of other vaccination campaigns over the last two decades.  

This study aims to estimate the non-vaccine costs of widespread Malaria vaccination implementation across Africa via the collection, itemization and standardization of vaccine cost studies in the literature. Its results provide estimates of _likely_ costs to be incurred by Malaria immunisation programmes.

# Methods

## Data collection

### Search strategy

For the purposes of both transparency and future reproducibility, we use a standard and automated search strategy. Our time frame of interest is 2000 to present day (June, 2016). Our search query is `r paste0("'((vaccine) OR (vaccination) OR (immunization)) AND (cost) AND (africa)'")`. The code for retrieving the papers and abstracts from PubMed (in the `r paste0("R")` programming language) is available [here](https://github.com/joebrew/gsk/blob/master/search_pubmed.R).

The initial query returned 985 results. We read the abstracts of all 985 papers, and eliminated more than 850 due to any of the following reasons:

- Geographic incompatibility (outside of sub-saharan Africa)
- Temporal incompatibility (outside of the time range in question)
- Subject matter irrelevance (non-human or animal vaccines, non-vaccines, opinion pieces, etc.)
- Lack of quantitative costing information

All 985 "original" papers, prior to manual exclusion, can be obtained [here](https://github.com/joebrew/gsk/blob/master/pubmed_results.csv?raw=true).

The first elimination round left 135 articles for manual inspection. All were read, and a further 94 were eliminated because they lacked itemized cost information, cost information was not clear, or the items listed were not categorized in a way as to make comparable to the larger body of literature.

### Selected studies

Below is a complete overview of all `r nrow(papers)` studies that both matched the automated selection criteria _and_ passed the manual filtering steps outlined above.

```{r}
temp <- papers %>%
  dplyr::select(title,
                year, 
                affiliation,
                all_authors,
                url)
names(temp) <- capitalize(gsub('_', ' ', names(temp)))
DT::datatable(temp)
```

## Data aggregation and cleaning

### Itemization and data extraction

Having finished selection, we extract from each study the itemized costs of immunization, excluding the actual purchase of vaccine. The categories are:

- Administration
- Equipment
- Human resources
- Sensitisation
- Training
- Transportation
- Wastage

In some cases, all of the above items were available. In most, only some of them were disclosed. In many cases, costs were given as a percentage of total, rather than in currency. 

The raw itemized data is below:

```{r}
x <- df %>% arrange(source)
names(x) <- toupper(names(x))
DT::datatable(x)
```

### Currency standardization

Following itemization, we standardize all costs from local currencies and past values to the equivalent of 2016 United States Dollars. For currency conversion from local to US dollars, we use publicly available exchange rates from [Quandl](https://www.quandl.com/collections/usa/usa-currency-exchange-rate). The currency values used for conversion are here:

```{r}
x <- currency
x <- x %>% arrange(date)
names(x) <- c('Currency', 'Date', 'Cost of 1 USD')
DT::datatable(x)
```

For inflation adjustment, we use the "Consumer Price Index" from the [United States Bureau of Labor and Statistics](http://data.bls.gov/cgi-bin/cpicalc.pl). 

The inflation rates used for this project are viewable here:

```{r}
x <- inflation %>%
    mutate(year = format(date, '%Y')) %>%
  dplyr::select(year, value_2016) %>%
  dplyr::rename(`2016 USD %` = value_2016,
         `Date` = year)
DT::datatable(x)
```


All costs reported herein are in 2016 US Dollars.

## Data analysis

### Point estimates and distributions

Having gathered and standardized item-specific vaccination programme costs, we estimate ranges for each item cost. Given the incompatibility of currency and percentage data, whenever possible we convert percentage data to 2016 USD, using available data to estimate overall cost.

### Geospatial determinants of vaccine cost

Having estimated the cost of vaccine implementation after standardization for time and currency, we can construct a continuous interpolated surface (raster) for vaccine cost. This allows us to generate country and region-specific estimates.


### Modeling

In addition to the country- and region-specific implementation costs estimation, we will estimate the effect of macroeconomic factors (GDP per capita, physician density, general indicators of health and health sector performance) on costs. Where significant, we will include these determinants into a final statistical model, which will be generalizable for future cost estimation, as well as more granular cost estimates.

# Results

## Item-specific vaccination implementation estimates

The number of articles reporting specific costs for each category of item costs can be visualized below.

```{r}
x <- df %>%
  group_by(Item = type) %>%
  dplyr::summarise(Articles = length(unique(source)))

ggplot(data = x,
       aes(x = Item, y = Articles)) +
  geom_bar(stat = 'identity',
           fill = 'darkred', alpha = 0.6) +
  theme_economist() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

What follows is a table of the same data

```{r}
DT::datatable(x)
```

What follows are charts showing the distribution of costs (both in currency and extrapolated from percentages) for each of the 7 implementation categories. The vertical line shows the average cost.

```{r}
types <- sort(unique(df$type))
for(i in 1:length(types)){
  this_type <- types[i]
  temp <- df %>% filter(type == this_type)
  the_mean <- mean(temp$cost)
  g <- ggplot(data = temp,
              aes(x = cost)) +
    geom_density(fill = 'darkred', alpha = 0.5) +
    theme_economist() +
    xlab('2016 US Dollars') +
    ylab('Density') +
    geom_vline(xintercept = the_mean, lty = 2) +
    ggtitle(this_type) +
    labs(subtitle = paste0('Average cost of ', round(the_mean, digits = 2)))
  print(g)
}
```

The below table shows the same costs.

```{r}
x <- df %>%
  dplyr::group_by(Item = type) %>%
  dplyr::summarise(Average = mean(cost),
                   Maximum = max(cost),
                   Minimum = min(cost),
                   articles = length(unique(source)))
DT::datatable(x)
```

## Aggregate cost estimation

In order to estimate the average overall (non-vaccine) implementation costs, we can run a Monte Carlo simulation. Performing 10,000 resamplings, we arrive at a distribution of the likely overall cost.

```{r}
n <- 10000
types <- sort(unique(df$type))
length_types <- length(types)
x <- data.frame(costs = rep(NA, n))
for (j in 1:length(types)){
  x[,types[j]] <- NA
}
for (i in 1:length(x$costs)){
  this_sample <- rep(NA, length_types)
  for (j in 1:length(types)){
    sample_from_these <- df$cost[df$type == types[j]]
    this_sample[j] <- sample(sample_from_these, 1)
    x[i,types[j]] <- this_sample[j]
  }
  x$costs[i] <- sum(this_sample, na.rm = TRUE)
}

ggplot(data = x,
       aes(x = costs)) +
  geom_density(fill = 'darkgreen', alpha = 0.6) +
  theme_economist() +
  xlab('2016 USD') +
  ylab('Density') +
  ggtitle('Total non-vaccine cost estimation') +
  geom_vline(xintercept = mean(x$costs, na.rm = TRUE), lty = 2) +
  labs(subtitle = paste0('Average cost of ', round(mean(x$costs, na.rm = TRUE), digits = 2)))
```

## Temporal dimensions of vaccine cost

An examination of item-specific costs over time shows no apparent secular trend. Accordingly, temporal data is explicitly ignored by our model.

```{r}
x <- df %>%
  dplyr::group_by(year, type) %>%
  dplyr::summarise(avg = mean(cost))

cols <- colorRampPalette(brewer.pal(9, 'Spectral'))(length(unique(x$type)))

ggplot(data = x,
       aes(x = year,
           y = avg,
           col = type)) +
  geom_line() +
  scale_color_manual(name = 'Item',
                     values = cols) +
  theme_economist() +
  xlab('Year') +
  ylab('Average cost (2016 USD)')
```

What follows is a table of the same data:

```{r}
x$avg <- round(x$avg, digits = 2)
names(x) <- c('Year', 'Item', 'Average cost')
DT::datatable(x)
```

## Geospatial determinants of vaccine cost

Not enough data on item-specific vaccine costs exist in the literature to form a model in which country itself is a stable predictor of cost. However, we can estimate geography's _general_ effect through generalized additive model.

Our model adjusts for item type, and uses a smoothed spatial surface to estimate the spatial effect of costs. The below map shows this effect.

```{r}
library(mgcv)
# Get latitude longitude
africa@data$lng <- coordinates(africa)[,1]
africa@data$lat <- coordinates(africa)[,2]
x <- df %>%
  dplyr::rename(COUNTRY = country) %>%
  dplyr::left_join(africa@data)

fit <- gam(cost ~ type + s(lng, lat, bs="ad"), data = x)

# Make a plot of africa
fake_africa <- africa@data
fake_africa$type <- 'Administration'
predictions <- predict(fit, fake_africa)

# Make a grid of africa
df_grid <- expand.grid(lng = seq(bbox(africa)[1,1],
                                 bbox(africa)[1,2],
                                 length = 1000),
                      lat = seq(bbox(africa)[2,1],
                                bbox(africa)[2,2],
                                length = 1000))
df_grid$x <- df_grid$lng
df_grid$y <- df_grid$lat
df_grid$type <- 'Administration'
df_grid$prediction <- predict(fit, df_grid)
# Make spatial
coordinates(df_grid) <- ~x+y
proj4string(df_grid) <- proj4string(africa)
# Create raster
# Keep only those within africa
x <- over(df_grid, polygons(africa))
df_grid_small <- df_grid[!is.na(x),]
temp <- df_grid_small@data %>% arrange(lng, lat)
r <- rasterFromXYZ(temp[, c('lng', 'lat', 'prediction')])
library(rasterVis)
levelplot(r, contour = TRUE) +
  layer(sp.lines(africa, lwd=0.8, col='white'))
```

As could be expected, the horn of Africa is likley to incur the highest costs. This could be due to a number of reasons, among them terrain and political instability.


# Discussion